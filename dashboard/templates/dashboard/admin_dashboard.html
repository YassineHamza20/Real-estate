<!-- templates/dashboard/admin_dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Analytics Dashboard</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom CSS -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
        
        // Pass data to JavaScript
        window.dashboardData = {
            totalBuyers: {{ total_buyers }},
            totalSellers: {{ total_sellers }},
            totalAdmins: {{ total_admins }},
            verifiedSellers: {{ verified_sellers }},
            pendingVerifications: {{ pending_verifications }},
            unsubmittedSellers: {{ unsubmitted_sellers }},
            propertyTypes: {
                labels: {{ property_types_labels|safe }},
                data: {{ property_types_data|safe }}
            },
            citiesData: {
                labels: {{ cities_labels|safe }},
                data: {{ cities_data|safe }}
            },
            roomsData: {
                labels: {{ rooms_labels|safe }},
                data: {{ rooms_data|safe }}
            },
            updateUrl: "{% url 'dashboard-api' %}"
        };
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-semibold text-sm">RE</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-semibold text-gray-900 dark:text-white">Real Estate Analytics</h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Live Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Theme Toggle -->
                    <button id="theme-toggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                        <span id="theme-icon">üåô</span>
                    </button>
                    
                    <!-- Simple Export -->
                    <button id="export-png" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700">
                        üì∏ Export PNG
                    </button>
                    
<a href="{% url 'export-pdf' %}" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 ml-2">
    üìÑ Export PDF Report
</a>
                    <a href="/admin/" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-900 dark:bg-gray-700 dark:hover:bg-gray-600">
                        Admin Panel
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-start mb-4">
                    <div class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Users</div>
                    <div class="text-blue-600 text-lg">üë•</div>
                </div>
                <div class="text-2xl font-bold text-gray-900 dark:text-white mb-2">{{ total_users }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">Registered Users</div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-start mb-4">
                    <div class="text-gray-500 dark:text-gray-400 text-sm font-medium">Properties</div>
                    <div class="text-green-600 text-lg">üè†</div>
                </div>
                <div class="text-2xl font-bold text-gray-900 dark:text-white mb-2">{{ total_properties }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">Listed Properties</div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-start mb-4">
                    <div class="text-gray-500 dark:text-gray-400 text-sm font-medium">Active Sellers</div>
                    <div class="text-cyan-600 text-lg">üíº</div>
                </div>
                <div class="text-2xl font-bold text-gray-900 dark:text-white mb-2">{{ total_sellers }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">Verified Partners</div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-start mb-4">
                    <div class="text-gray-500 dark:text-gray-400 text-sm font-medium">Wishlist Saves</div>
                    <div class="text-pink-600 text-lg">‚ù§Ô∏è</div>
                </div>
                <div class="text-2xl font-bold text-gray-900 dark:text-white mb-2">{{ total_wishlists }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">Total Saves</div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
            <!-- User Distribution -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700 lg:col-span-1">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">User Distribution</h3>
                <canvas id="usersChart" height="250"></canvas>
            </div>
            
            <!-- Property Types -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700 lg:col-span-1">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Property Types</h3>
                <canvas id="propertiesChart" height="250"></canvas>
            </div>
            
            <!-- Properties by City -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700 lg:col-span-1">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Properties by City</h3>
                <canvas id="citiesChart" height="250"></canvas>
            </div>
            
            <!-- Room Distribution -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700 lg:col-span-1">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Room Distribution</h3>
                <canvas id="roomsChart" height="250"></canvas>
            </div>
            
            <!-- Seller Verification -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700 lg:col-span-1">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Seller Verification</h3>
                <canvas id="verificationChart" height="250"></canvas>
            </div>
        </div>

        <!-- Data Tables -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Recent Properties -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Recent Properties</h3>
                <div class="space-y-3">
                    {% for property in recent_properties %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-900 dark:text-white text-sm truncate">{{ property.name }}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">by {{ property.seller.username }} ‚Ä¢ {{ property.city }}</div>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <span class="text-green-600 font-semibold text-sm">{{ property.price }} euros</span>
                            <span class="text-pink-600 text-xs">‚ù§Ô∏è {{ property.wishlist_count }}</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-gray-500 dark:text-gray-400 py-4">No recent properties</div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Most Popular -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Most Popular</h3>
                <div class="space-y-3">
                    {% for property in most_wishlisted %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-900 dark:text-white text-sm truncate">{{ property.name }}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">{{ property.city }} ‚Ä¢ {{ property.property_type }}</div>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <span class="bg-pink-600 text-white px-2 py-1 rounded text-xs font-medium">{{ property.wishlist_count }} saves</span>
                            <span class="text-green-600 font-semibold text-sm">{{ property.price }} euros</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-gray-500 dark:text-gray-400 py-4">No wishlisted properties</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const data = window.dashboardData;
            const isDark = document.documentElement.classList.contains('dark');
            
            // Chart colors for light/dark mode
            const colors = {
                text: isDark ? '#f9fafb' : '#111827',
                grid: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
                primary: '#3b82f6',
                secondary: '#10b981',
                accent: '#0ea5e9',
                warning: '#f59e0b',
                neutral: '#6b7280'
            };

            // 1. User Distribution Chart
            new Chart(document.getElementById('usersChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Buyers', 'Sellers', 'Admins'],
                    datasets: [{
                        data: [data.totalBuyers, data.totalSellers, data.totalAdmins],
                        backgroundColor: [colors.primary, colors.secondary, colors.accent],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: colors.text }
                        }
                    },
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const labels = ['Buyers', 'Sellers', 'Admins'];
                            alert(`Drill-down: ${labels[index]} - ${evt.chart.data.datasets[0].data[index]} users`);
                        }
                    }
                }
            });

            // 2. Property Types Chart
            if (data.propertyTypes.labels.length > 0) {
                new Chart(document.getElementById('propertiesChart'), {
                    type: 'pie',
                    data: {
                        labels: data.propertyTypes.labels,
                        datasets: [{
                            data: data.propertyTypes.data,
                            backgroundColor: [colors.primary, colors.secondary, colors.accent, colors.warning, colors.neutral],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: colors.text }
                            }
                        },
                        onClick: (evt, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const label = data.propertyTypes.labels[index];
                                const value = data.propertyTypes.data[index];
                                alert(`Drill-down: ${label} - ${value} properties`);
                            }
                        }
                    }
                });
            }

            // 3. Cities Chart
            if (data.citiesData.labels.length > 0) {
                new Chart(document.getElementById('citiesChart'), {
                    type: 'bar',
                    data: {
                        labels: data.citiesData.labels,
                        datasets: [{
                            data: data.citiesData.data,
                            backgroundColor: colors.primary,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: colors.grid },
                                ticks: { color: colors.text }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: colors.text }
                            }
                        },
                        plugins: { legend: { display: false } },
                        onClick: (evt, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const label = data.citiesData.labels[index];
                                const value = data.citiesData.data[index];
                                alert(`Drill-down: ${label} - ${value} properties`);
                            }
                        }
                    }
                });
            }

            // 4. Rooms Chart
            if (data.roomsData.labels.length > 0) {
                new Chart(document.getElementById('roomsChart'), {
                    type: 'bar',
                    data: {
                        labels: data.roomsData.labels,
                        datasets: [{
                            data: data.roomsData.data,
                            backgroundColor: colors.accent,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: colors.grid },
                                ticks: { color: colors.text }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: colors.text }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // 5. Verification Chart
            new Chart(document.getElementById('verificationChart'), {
                type: 'bar',
                data: {
                    labels: ['Verified', 'Pending', 'Not Submitted'],
                    datasets: [{
                        data: [data.verifiedSellers, data.pendingVerifications, data.unsubmittedSellers],
                        backgroundColor: [colors.secondary, colors.warning, colors.neutral],
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: colors.grid },
                            ticks: { color: colors.text }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: colors.text }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Theme Toggle
          // Theme Toggle - FIXED
document.getElementById('theme-toggle').addEventListener('click', function() {
    const isDark = document.documentElement.classList.toggle('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    document.getElementById('theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    
    // Update charts without reloading page
    updateChartThemes(isDark);
});

// Function to update chart themes
function updateChartThemes(isDark) {
    const colors = {
        text: isDark ? '#f9fafb' : '#111827',
        grid: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
    };

    // Update all charts with new theme colors
    Chart.helpers.each(Chart.instances, function(chart) {
        chart.options.scales.x.ticks.color = colors.text;
        chart.options.scales.y.ticks.color = colors.text;
        chart.options.scales.y.grid.color = colors.grid;
        if (chart.options.plugins.legend && chart.options.plugins.legend.labels) {
            chart.options.plugins.legend.labels.color = colors.text;
        }
        chart.update('none');
    });
}

            // Export PNG
            document.getElementById('export-png').addEventListener('click', function() {
                const charts = ['usersChart', 'propertiesChart', 'citiesChart', 'roomsChart', 'verificationChart'];
                charts.forEach(chartId => {
                    const canvas = document.getElementById(chartId);
                    if (canvas) {
                        const link = document.createElement('a');
                        link.download = `chart-${chartId}-${new Date().toISOString().split('T')[0]}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    }
                });
                alert('All charts exported as PNG! Check your downloads folder.');
            });

            // Update time
            function updateTime() {
                const now = new Date();
                document.getElementById('current-time').textContent = now.toLocaleTimeString();
            }
            updateTime();
            setInterval(updateTime, 60000);
        });
    </script>
</body>
</html>